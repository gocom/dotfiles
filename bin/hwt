#!/usr/bin/env bash

usage () {
  cat <<EOF
Extract and package Huawei .hwt theme files.

Usage:
  $ ${0##*/} [options] [extract|package] [filename]

Options:
  -h, --help     Print this message
  -v, --version  Print version number

Commands:
  $ ${0##*/} extract <filename>
  Extract a theme file.

  $ ${0##*/} package [directory]
  Package a directory.

Examples:
  $ ${0##*/} extract MyIconTheme.hwt
  $ ${0##*/} package MyIconTheme
EOF
}

free () {
  local name index ext directory basename filename

  name="$1"
  directory="$(dirname "$1")"
  basename="$(basename "$1")"
  filename="${basename%.*}"
  ext="${basename##*.}"
  index=0

  if ! [ "$ext" = "" ] && ! [ "$basename" = "$ext" ]; then
    ext=".$ext"
  else
    ext=""
  fi

  while true; do
    if ! [ -e "$name" ]; then
      break
    fi

    ((index++))
    name="$directory/$filename-$index$ext"
  done

  printf '%s' "$name"
}

extract () {
  local base name f fzip

  if ! [ "${1:-}" ]; then
    echo "Filename must be specified." >&2
    return 1
  fi

  if ! [ -f "$1" ] || ! [ -r "$1" ]; then
    echo "Can not read '$1'" >&2
    return 1
  fi

  zip="$(mktemp --suffix=".zip")" || return 1
  trap 'rm -f "$zip"' EXIT

  base="$(basename "$1")"
  name="$(free "${base%.*}")"

  cp "$1" "$zip" || return 1
  unzip "$zip" -d "$name" > /dev/null 2>&1  || return 1
  rm -f "$zip" || return 1
  cd "$name" > /dev/null || return 1

  for f in *; do
    if [ -f "$f" ]; then
      fzip="$(free "$f.zip")"
      mv "$f" "$fzip" || continue
      unzip "$fzip" -d "$f" > /dev/null 2>&1 || mv "$fzip" "$f"
      rm -f "$fzip" || continue
    fi
  done
}

package () {
  local src cwd fzip f

  cwd="$PWD"
  src="${1:-}"

  if ! [ "$src" ] || [ "$src" = "." ]; then
    src="$PWD"
  fi

  tmp="$(mktemp -d)" || return 1
  trap 'rm -rf "$tmp"' EXIT

  mkdir "$tmp/data" || return 1
  cp -r "$src/"* "$tmp/data" || return 1
  cd "$tmp/data" || return 1

  for f in "icons"; do
    if [ -d "$f" ]; then
      fzip="$(free "$f.zip")"
      cd "$f" > /dev/null || return 1
      zip -r -X "../$fzip" ./* > /dev/null 2>&1 || return 1
      cd ".." || return 1
      rm -rf "$f" || return 1
      mv "$fzip" "$f" || return 1
    fi
  done

  zip -r -X "../theme.zip" ./* > /dev/null 2>&1 || return 1
  cd "$cwd" || return 1
  mv "$tmp/theme.zip" "$(free "$(basename "$src").hwt")" || return 1
  rm -rf "$tmp"
}

case "${1:-}" in
  -v|--version) echo "0.0.0" ;;
  extract) extract "${@:2}" ;;
  package) package "${@:2}" ;;
  *) usage ;;
esac
