#!/usr/bin/env bash

app_name="${0##*/}"
app_version="0.0.0"

config_directory="${XDG_CONFIG_HOME:-$HOME/.config}"
data_directory="${XDG_DATA_HOME:-$HOME/.local/share}"
executable="${EXECUTABLE:-$app_name}"

usage () {
  cat <<EOF
Launch gcloud shell.

Runs gcloud inside a container to avoid conflicts with host system
dependencies.

Usage:
  $ $app_name [options] [command]

Commands:
  install  Install gcloud
  update   Update gcloud
  shell    Login to gcloud image

Options:
  -h, --help     Print this message
  -v, --version  Print version number

Example:
  $ $app_name
EOF
}

install () {
  docker pull google/cloud-sdk:latest
}

main () {
  if ! [ -e "$data_directory/google-cloud-sdk-docker" ]; then
  	install || return 1
  	mkdir -p "$data_directory/google-cloud-sdk-docker" || return 1
  	mkdir -p "$config_directory/gcloud" || return 1
  fi

  cd "$data_directory/google-cloud-sdk-docker" || return 1

  docker run -it \
    -v "$config_directory/gcloud:/root/.config/gcloud" \
    -v "$HOME/.ssh:/root/.ssh" \
    google/cloud-sdk "$executable" "$@"
}

case "${1:-}" in
  -h|--help) usage ;;
  -v|--version) echo "$app_version" ;;
  install|update) install ;;
  shell) executable=bash main "${@:2}" ;;
  *) main "$@" ;;
esac
