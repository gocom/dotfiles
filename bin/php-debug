#!/usr/bin/env bash

app_name="${0##*/}"

usage () {
  cat <<EOF
Run PHP with debug configs.

Usage:
  $ $app_name [options]

Options:
  -h, --help     Print this message
  -v, --version  Print version number

Examples:
  $ $app_name /usr/local/bin/composer test
EOF
}

main () {
  local f args dirs prefix separator config

  args=()
  config="${app_name#*-}"
  dirs="$(php -r "echo PHP_CONFIG_FILE_SCAN_DIR;")"
  separator="$(php -r "echo PATH_SEPARATOR;")"
  prefix="$(php -r "echo PHP_SYSCONFDIR;")"

  if ! [ "$prefix" ]; then
    exit 1
  fi

  for f in "$prefix"/"$app_name".ini; do
    if [ -e "$f" ]; then
      args+=("-c")
      args+=("$f")
    fi
  done

  for f in "$prefix/$config".d; do
    if [ -e "$f" ]; then
      if [ "$dirs" ]; then
        dirs="$dirs$separator$f"
      else
        dirs="$f"
      fi
    fi
  done

  if [ "$dirs" ]; then
    export "PHP_INI_SCAN_DIR"="$dirs"
  fi

  set -- "${args[@]}" "$@"
  exec php "$@"
}

case "${1:-}" in
  -h|--help) usage ;;
  -v|--version) echo "0.0.0" ;;
  *) main "$@" ;;
esac
